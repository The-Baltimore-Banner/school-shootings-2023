---
title: "schools-crime"
output: html_document
date: "2023-01-05"
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readr)
library(janitor)
library(lubridate)
library(sf)
library(mapview)
library(RColorBrewer)
options(digits=3)
options(scipen=999)
'%notin%' <- Negate('%in%')

#does a standard group_by and count() with percentage
grouper <- function(input_df, group_by_column, new_column_name = "n()"){
  output_df <- input_df %>%
    group_by(.data[[group_by_column]]) %>%
    summarise(temp_count = n()) %>%
    mutate(percent = temp_count/sum(temp_count)*100) %>%
    arrange(desc(percent)) %>%
    rename(!!new_column_name := temp_count)
  return(output_df)
}

#group/counts every column in input dataframe
group_count <- function(input_df, group_column_name='n()', state_filter=NA, start_col = 1){
  column_names <- colnames(input_df)
  if(!is.na(state_filter)){
    input_df <- input_df %>%
      filter(state == state_filter)
  }
  for (column in column_names[start_col:length(column_names)]){
    output <- grouper(input_df, column, group_column_name)
    print(output)
  }
}

grouper_sum <- function(input_df, group_by_column, sum_column, new_column_name = "n()"){
  output_df <- input_df %>%
    group_by(.data[[group_by_column]]) %>%
    summarise(temp_count = sum(.data[[sum_column]])) %>%
    mutate(percent = temp_count/sum(temp_count)*100) %>%
    arrange(desc(percent)) %>%
    rename(!!new_column_name := temp_count)
  return(output_df)
  
}

#lowers case of every character column in a dataframe
lower_df <- function(input_df){
  names <- colnames(input_df)
  output_df <- input_df
  names <- colnames(output_df)
  for (name in names){
    if (is.character(output_df[[name]])){
      output_df[[name]] <- tolower(output_df[[name]])
      #print('yes')
    } else {
      output_df[[name]] <- output_df[[name]]
      #print('no')
    }
  }
  return(output_df)
}



"Because the Census estimates are not exact counts, there is some uncertainty in the analysis. The data is published with rolling 5-year estimates that include a margin of error. To account for these possibilities, we have to calculate a minimum population, an average population and a maximum population. If the margin of error was significantly larger in a given district, itâ€™s possible that district could have a minimum population loss but a maximum population gain. "

```

```{r}



parcels <- read_sf('/Users/ryanlittle/code/data-library/baltimore/baltimore-shapes/Real_Property_Information/Real_Property_Information.shp') %>%
  clean_names() %>%
  lower_df()

victims <- read_csv('data/Part_1_Crime_Data_.csv') %>%
  #cleaning column names
  clean_names() %>%
  #lowering text in df
  lower_df() %>%
  #converting to lubridate
  mutate(crime_date_time = ymd_hms(crime_date_time))  %>%
  #making year month hour columns
  mutate(year = year(crime_date_time),
         month = month(crime_date_time),
         hour = hour(crime_date_time),
         date = as_date(crime_date_time, 'day')) %>%
  #removing lat/long because there are multiples and ethnicity because it is unreliable and uneccesary for weekend count analysis
  select(-x, -y, -row_id, -latitude, -longitude, -ethnicity) %>%#, -shape) %>%
  #filtering for year
  #filter(year >= 2011) %>%
  #splitting geo location
  separate(geo_location, c("latitude", "longitude"), ',') %>%
  #removing parenthesis
  mutate(latitude = gsub('\\(', '', latitude),
         longitude = gsub('\\)', '', longitude)) %>%
  mutate(age = case_when(
    age > 0 & age < 100 ~ age,
    TRUE ~ NA_real_
  )) %>%
  mutate(age_range = case_when(
    age < 18 & age > 0 ~ "juvenile",
    age >= 18 & age <= 25 ~ "18 to 25",
    age >= 26 & age <= 34 ~ "26 to 34",
    age >= 35 & age <= 50 ~ "35 to 50",
    age > 50 & age < 75 ~ "51 to 74",
    age >= 75 & age < 85 ~ "75 to 84",
    age >= 85 ~ "85 to 100",
    TRUE ~ "NA"
  )) %>%
  mutate(time_range = case_when(
    hour <= 3 ~ "early morning",
    hour < 12 & hour > 3 ~ "morning",
    hour >= 12 & hour < 15 ~ "early afternoon",
    hour >= 13 & hour < 17 ~ "after school",
    hour >= 17 & hour < 20 ~ "evening",
    hour >= 20 ~ "night"
  ))  %>%
  ###############
  ###############
  mutate(during_school = case_when(
    hour >= 7 & hour <= 15 ~ TRUE,
    TRUE ~ FALSE
  )) %>%
  mutate(around_lunch = case_when(
    hour >= 10 & hour <= 1 ~ TRUE,
    TRUE ~ FALSE
  )) %>%
  ###############
  ###############
  mutate(quarter = case_when(
    month %in% c(1,2,3) ~ 1,
    month %in% c(4,5,6) ~ 2,
    month %in% c(7,8,9) ~ 3,
    month %in% c(10,11,12) ~ 4
  )) %>%
  mutate(quarter_date = case_when(
    quarter == 1 ~ ymd(paste0(year, "-3-31")),
    quarter == 2 ~ ymd(paste0(year, "-6-30")),
    quarter == 3 ~ ymd(paste0(year, "-9-30")),
    quarter == 4 ~ ymd(paste0(year, "-12-31"))
  )) %>%
  filter(year >= 2015)
  
crimes <- victims %>%
  #filter(description %in% c("shooting", "homicide"),
  #       weapon == "firearm") %>%
  #mutating database of victims to database of distinct crimes
  group_by(crime_date_time, location, district, neighborhood, description, weapon, premise, year, month, date, time_range, during_school, around_lunch, quarter, longitude, latitude) %>%
  summarise(victims = n(),
            average_age = mean(age, na.rm = TRUE),
            juvenile_victims = sum(age_range == "juvenile")) %>%
  filter(longitude != "",
         latitude != "") %>%
  st_as_sf(coords = c("longitude", "latitude"),
                 crs = 4326,#4269, 
                 remove = FALSE)

crimes$id <- seq.int(nrow(crimes))

schools <- read_csv("data/Schoollist.csv") %>% 
  clean_names() %>%
  lower_df()

pal <-  mapviewPalette("mapviewSpectralColors")

```




#ISOLATE HIGH SCHOOLS IN SHAPE FILE

```{r}

high_schools <- schools %>%
  filter(str_detect(official_state_grade_band, "high")) %>%
  rename(long = address_longitude,
         lat = address_latitude) %>%
  select(school_name, address, zip, lat, long) %>%
  mutate(long = as.numeric(long)) %>%
  mutate(address = gsub("street", "st", address),
         address = gsub("avenue", "ave", address),
         address = gsub("lane", "ln", address),
         address = gsub("lane", "ln", address),
         address = gsub(", baltimore md", "", address),
         address = gsub("road", "rd", address),
         address = gsub("parkway", "", address),
         address = gsub("lane", "ln", address)
         )

high_schools <- st_as_sf(high_schools, coords = c("lat", "long"), crs="NAD83")

high_schools 

```

```{r}

length(unique(high_schools$address))

high_school_parcels <- parcels %>%
  filter(fulladdr == "NOTHING")

for (high_school in unique(high_schools$address)){
  
  temp <- parcels %>%
     filter(str_detect(fulladdr, high_school))
  
  if (nrow(temp) > 0){
    print("success")
  } else {
    print(paste0(high_school, " failed"))
  }
  
  high_school_parcels <- high_school_parcels %>%
    bind_rows(temp)
  
}

failures <- c("1400 w cold spring ln", "2801 n dukeland st", "926 greenmount ave", "3500 hillen rd", "2700 seamon ave", "2555 harford rd", "1301 mcculloh",
              "4600 falls rd", "1510 west lafayette ave")

```


```{r}

high_schools %>%
  filter(address %in% failures)

```


```{r}

parcels %>%
  filter(str_detect(fulladdr, "cold spring")) %>%
  select(fulladdr, owner_1) %>%
  filter(str_detect(fulladdr, "14"))

```

############## JUNK


```{r}

parcels %>%
  filter(str_detect(PROPDESC, "SCHOOL")) %>%
  select(PROPDESC) %>%
  separate(PROPDESC, c("junk", "school_num"), " #")  %>%
  filter(!is.na(school_num)) %>%
  mutate(school_num = as.numeric(school_num)) %>%
  filter(school_num %in% high_schools$school_number)

```

```{r}

intersection <- st_intersection(high_schools, parcels)

st_crs(parcels)

```

```{r}

st_crs(high_schools)

```


# ANALYZE SHOOTINGS WITH X BLOCKS


```{r}

for (parcel in high_school_parcels$geometry){
  
  print(mapview(parcel))
  
}

```

```{r}

near_school <- function(blocks, school_shape){

  distance <- blocks*100+50  

  in_school <- as.data.frame(st_is_within_distance(crimes, school_shape, dist = 0, sparse = FALSE)) %>%
    clean_names() %>%
    mutate(inside = case_when(
       v1 == TRUE ~ TRUE,
       #v2 == TRUE ~ TRUE,
       #v3 == TRUE ~ TRUE,
       #v4 == TRUE ~ TRUE,
       TRUE ~ FALSE
    )) %>%
    select(inside)
  
  near_school <- as.data.frame(st_is_within_distance(crimes, school_shape, dist = distance, sparse = FALSE)) %>%
    clean_names() %>%
    mutate(near = case_when(
       v1 == TRUE ~ TRUE,
       #v2 == TRUE ~ TRUE,
       #v3 == TRUE ~ TRUE,
       #v4 == TRUE ~ TRUE,
       TRUE ~ FALSE
    )) %>%
    select(near) %>%
    filter()
  
  near_school <- crimes %>%
    cbind(near_school$near, in_school$inside) %>%
    clean_names() %>%
    filter(near_school_near == TRUE,
           in_school_inside == FALSE)
  
  map <- mapView(school_shape$geometry, alpha.regions = 0, color = "red", lwd = 2, layer.name = "Western District") + 
  mapview(near_school$geometry,
          cex = near_school$victims*2.5, 
          legend = TRUE, 
          col.regions = pal(100), 
          layer.name = "Shooting victims")
  
  near_school_by_year <- near_school %>%
    as.data.frame() %>%
    #mutate(year_month = mdy(paste0(month, "-1-", year))) %>%
    group_by(year) %>%
    summarise(crimes = n(),
              victims = sum(victims))
  
  plot <- ggplot(near_school_by_year, aes(x=year, y=crimes)) +
    geom_line() +
    ggtitle(paste0("crimes within ", blocks, " block(s) of Western District"))
  
  print(map)
  print(plot)
  print(near_school_by_year %>%
        mutate(blocks = paste0(blocks)) %>%
        select(blocks, crimes, year) %>%
        pivot_wider(values_from = crimes, names_from = year))

}

near_school(1, high_school_parcels$geometry[1])

```


